<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Muncher: 4th Grade Edition</title>
    <style>
        /* RETRO STYLING */
        body {
            background-color: #1a1a1a;
            color: #33ff00;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #game-container {
            border: 4px solid #33ff00;
            padding: 20px;
            background-color: #000;
            box-shadow: 0 0 20px rgba(51, 255, 0, 0.2);
            text-align: center;
        }

        h1 { margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px; }
        
        #hud {
            display: flex;
            justify-content: space-between;
            width: 500px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 18px;
        }

        #instruction-box {
            background-color: #33ff00;
            color: black;
            padding: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        /* GRID SYSTEM */
        #grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            width: 500px;
            height: 400px;
            margin: 0 auto;
        }

        .cell {
            background-color: #002200;
            border: 1px solid #004400;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            position: relative;
        }

        /* THE MUNCHER (PLAYER) */
        .player {
            background-color: #33ff00 !important;
            color: black !important;
            border: 2px solid white !important;
            font-weight: bold;
            box-shadow: 0 0 10px #33ff00;
        }

        /* ANIMATIONS */
        .eaten { visibility: hidden; }
        
        .correct-flash { animation: flashGreen 0.2s; }
        .wrong-flash { animation: flashRed 0.4s; }

        @keyframes flashGreen {
            0% { background-color: white; }
            100% { background-color: #002200; }
        }
        @keyframes flashRed {
            0% { background-color: red; }
            50% { background-color: red; }
            100% { background-color: #002200; }
        }

        #controls { margin-top: 15px; font-size: 14px; color: #88ff88; }
        
        /* MENU STYLES */
        button {
            background: black;
            color: #33ff00;
            border: 2px solid #33ff00;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 18px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #33ff00; color: black; }

        #game-over, #menu {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="game-container">
        <h1>Math Muncher</h1>
        
        <div id="hud">
            <span>Score: <span id="score">0</span></span>
            <span>Lives: <span id="lives">3</span></span>
        </div>

        <div id="instruction-box">Target: <span id="target-rule">LOADING...</span></div>

        <div id="grid">
            </div>

        <div id="controls">
            Use <b>ARROW KEYS</b> to move. Press <b>SPACE</b> to Munch.
        </div>
    </div>

    <div id="menu">
        <h1>SELECT MODE</h1>
        <button onclick="startGame('multiples')">Multiples</button>
        <button onclick="startGame('factors')">Factors</button>
    </div>

    <div id="game-over" class="hidden">
        <h1>GAME OVER</h1>
        <p>Final Score: <span id="final-score">0</span></p>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <script>
        // GAME STATE
        const GRID_W = 6;
        const GRID_H = 5;
        let score = 0;
        let lives = 3;
        let playerPos = { x: 0, y: 0 };
        let gridData = []; // Stores numbers and status
        let currentMode = ''; 
        let currentTarget = 0;
        let level = 1;

        // DOM ELEMENTS
        const gridEl = document.getElementById('grid');
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const ruleEl = document.getElementById('target-rule');
        const menuEl = document.getElementById('menu');
        const gameOverEl = document.getElementById('game-over');
        const finalScoreEl = document.getElementById('final-score');

        // AUDIO CONTEXT (Simple beeps)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'move') {
                osc.frequency.value = 200;
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'eat') {
                osc.frequency.value = 600;
                osc.type = 'square';
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
            } else if (type === 'bad') {
                osc.frequency.value = 100;
                osc.type = 'sawtooth';
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'win') {
                osc.frequency.value = 800;
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            }
        }

        // INITIALIZATION
        function startGame(mode) {
            currentMode = mode;
            menuEl.classList.add('hidden');
            resetLevel();
        }

        function resetLevel() {
            // Determine Math Rule
            if (currentMode === 'multiples') {
                // Multiples of 2 through 12
                currentTarget = Math.floor(Math.random() * 11) + 2; 
                ruleEl.innerText = `Find MULTIPLES of ${currentTarget}`;
            } else {
                // Factors of numbers between 10 and 50
                const easyComposites = [12, 16, 18, 20, 24, 30, 32, 36, 40, 42, 45, 48, 50];
                currentTarget = easyComposites[Math.floor(Math.random() * easyComposites.length)];
                ruleEl.innerText = `Find FACTORS of ${currentTarget}`;
            }
            
            generateGrid();
            renderGrid();
        }

        function generateGrid() {
            gridData = [];
            let correctCount = 0;
            const totalCells = GRID_W * GRID_H;

            // Generate numbers
            for (let i = 0; i < totalCells; i++) {
                let num;
                let isCorrect = false;

                // 30% chance to generate a correct answer naturally
                if (Math.random() < 0.3) {
                    isCorrect = true;
                }

                if (currentMode === 'multiples') {
                    if (isCorrect) {
                        num = currentTarget * (Math.floor(Math.random() * 10) + 1);
                    } else {
                        // Generate wrong number (ensure it's NOT a multiple)
                        do {
                            num = Math.floor(Math.random() * (currentTarget * 10)) + 1;
                        } while (num % currentTarget === 0);
                    }
                } else { // FACTORS
                    if (isCorrect) {
                        // Find actual factors
                        let factors = [];
                        for(let k=1; k<=currentTarget; k++) {
                            if(currentTarget % k === 0) factors.push(k);
                        }
                        num = factors[Math.floor(Math.random() * factors.length)];
                    } else {
                        // Generate wrong number (ensure it's NOT a factor)
                        do {
                            num = Math.floor(Math.random() * currentTarget) + 1;
                        } while (currentTarget % num === 0);
                    }
                }
                
                gridData.push({ val: num, eaten: false, isTarget: isCorrect });
                if (isCorrect) correctCount++;
            }

            // Ensure at least 3 correct answers exist, otherwise regenerate
            if (correctCount < 3) generateGrid();
        }

        function renderGrid() {
            gridEl.innerHTML = '';
            gridData.forEach((cell, index) => {
                const div = document.createElement('div');
                div.classList.add('cell');
                div.id = `cell-${index}`;
                
                if (cell.eaten) {
                    div.classList.add('eaten');
                } else {
                    div.innerText = cell.val;
                }

                // Check if player is here
                const px = index % GRID_W;
                const py = Math.floor(index / GRID_W);
                if (px === playerPos.x && py === playerPos.y) {
                    div.classList.add('player');
                }

                gridEl.appendChild(div);
            });
        }

        // INPUT HANDLING
        document.addEventListener('keydown', (e) => {
            if (!menuEl.classList.contains('hidden')) return;
            if (!gameOverEl.classList.contains('hidden')) return;

            switch(e.key) {
                case 'ArrowUp': 
                    if (playerPos.y > 0) playerPos.y--; 
                    playSound('move');
                    break;
                case 'ArrowDown': 
                    if (playerPos.y < GRID_H - 1) playerPos.y++; 
                    playSound('move');
                    break;
                case 'ArrowLeft': 
                    if (playerPos.x > 0) playerPos.x--; 
                    playSound('move');
                    break;
                case 'ArrowRight': 
                    if (playerPos.x < GRID_W - 1) playerPos.x++; 
                    playSound('move');
                    break;
                case ' ': // Spacebar
                    attemptMunch();
                    break;
            }
            renderGrid();
        });

        function attemptMunch() {
            const index = playerPos.y * GRID_W + playerPos.x;
            const cell = gridData[index];

            if (cell.eaten) return;

            if (isCorrectAnswer(cell.val)) {
                // CORRECT
                score += 100;
                scoreEl.innerText = score;
                cell.eaten = true;
                playSound('eat');
                document.getElementById(`cell-${index}`).classList.add('correct-flash');
                checkWinCondition();
            } else {
                // WRONG
                lives--;
                livesEl.innerText = lives;
                playSound('bad');
                document.getElementById(`cell-${index}`).classList.add('wrong-flash');
                
                if (lives <= 0) {
                    endGame();
                }
            }
        }

        function isCorrectAnswer(val) {
            if (currentMode === 'multiples') {
                return val % currentTarget === 0;
            } else {
                return currentTarget % val === 0;
            }
        }

        function checkWinCondition() {
            // Are there any correct answers left?
            const remaining = gridData.filter(c => !c.eaten && isCorrectAnswer(c.val));
            if (remaining.length === 0) {
                playSound('win');
                setTimeout(() => {
                    alert("Level Cleared! Next Round.");
                    level++;
                    resetLevel();
                }, 500);
            }
        }

        function endGame() {
            finalScoreEl.innerText = score;
            gameOverEl.classList.remove('hidden');
        }

    </script>
</body>
</html>
